---
layout: post
title: Thread(스레드)란?     # Title of the page
author: yunjigo                   
color: rgb(36,41,46)                          # Add the specified color as feature image, and change link colors in post
bootstrap: true                                   # Add bootstrap to the page
tags: [study,스레드,스레드덤프,thread,thread dump]
excerpt_separator: <!--more-->
---


### Thread(스레드)의 정의

스레드(thread)는 어떠한 프로그램 내에서, 특히 프로세스 내에서 실행되는 흐름의 단위를 말한다.  <!--more-->
일반적으로 한 프로그램은 하나의 스레드를 가지고 있지만, 프로그램 환경에 따라 둘 이상의 스레드를 동시에 실행할 수 있다.  
이러한 실행 방식을 멀티스레드(multithread)라고 한다.

---

### Thread(스레드) 와 (Process)프로세스의 차이
멀티프로세스와 멀티스레드는 양쪽 모두 여러 흐름이 동시에 진행된다는 공통점을 가지고 있다.  
하지만 멀티프로세스에서 각 프로세스는 독립적으로 실행되며 각각 별개의 메모리를 차지하고 있는 것과 달리 **멀티스레드는 프로세스 내의 메모리를 공유해 사용**할 수 있다. 
또한 프로세스 간의 전환 속도보다 스레드 간의 전환 속도가 빠르다.  

	스레드 < 프로세스 이며, 하나의 프로세스 내에서 여러개의 프로세스가 운영될 수 있다.

---  


### Thread(스레드)의 종류
#### 1.User-Level Thread  
쉽게 말하자면, 우리가 코드로 구현하는 모든 스레드는 User-Level 스레드라고 할 수 있다.  
사용자 레벨 스레드는 사용자에 의해 구현되며 커널은 이러한 스레드의 존재를 인식하지 못한다.  
마치 단일 스레드 프로세스인 것처럼 처리한다. 그래서 사용자 레벨 스레드는 커널 레벨 스레드보다 작고 훨씬 빠르다.  
유저 레벨 스레드는 프로그램 카운터 (PC), 스택, 레지스터 및 작은 프로세스 제어 블록으로 사용된다.  
또한 사용자 레벨 스레드 동기화에는 커널이 관여하지 않는다.
- 장점  
	- 사용자 레벨 스레드는 커널 레벨 스레드보다 쉽고 빠르다.  
	- 더 쉽게 관리가 가능하다.  
	- 사용자 레벨 스레드는 모든 운영 체제에서 실행될 수 있다.  
	- 사용자 레벨 스레드에서는 스레드 전환에 필요한 커널모드 권한이 필요없다.  
	
- 단점  
	- 여러 개의 사용자 스레드 중 하나의 스레드가 시스템 호출 등으로 중단되면 나머지 모든 스레드 역시 중단된다.  
	커널이 프로세스 내부의 스레드를 인식하지 못하며 해당 프로세스를 대기 상태로 전환시키기 때문이다.  
	- 시스템 전반에 걸친 스케줄링 우선순위를 지원하지 않는다.(어떤 스레드가 먼저 동작할 지 모른다.)




#### 2.Kernel-Level Thread  
커널 레벨 스레드는 운영 체제에서 직접 처리하며 스레드 관리는 커널에서 수행한다.  
프로세스 및 프로세스 스레드에 대한 컨텍스트 정보는 모두 커널에 의해 관리된다.  
이 때문에 커널 레벨 스레드는 사용자 레벨 스레드보다 느리다.  
하나의 프로세스는 적어도 하나의 커널 스레드를 가지게 된다.  
- 장점  
	- 커널 레벨 스레드가 차단되더라도 동일한 프로세스 내의 다른 스레드를 커널에서 예약 할 수 있다.  
	- 프로세스의 스레드들을 몇몇 프로세서에 한꺼번에 디스패치 할 수 있기 때문에 멀티프로세서 환경에서 매우 빠르게 동작한다.
	- 커널이 각 스레드를 개별적으로 관리할 수 있다.  
	
- 단점
	- 프로세스에서 한 스레드에서 다른 스레드로 제어를 전송하려면 모드를 커널 모드로 전환해야해서 느리다.
	즉, 사용자 모드에서 커널 모드로의 전환이 빈번하게 이뤄져 성능 저하가 발생한다.
	- 사용자가 프로그래밍할 때 구현하기 어렵고 자원을 더 많이 소비하는 경향이 있다.  
	
--- 


### JAVA에서의 스레드 
스레드 덤프에 대해서 알기 위해서는 먼저, 자바의 스레드에 관해 자세한 이해가 우선되어야 한다.  
스레드는 위에서 언급한 것과 같이 다른 스레드와 동시에 실행할 수 있다.  
여러 스레드가 공유 자원을 사용할 때 정합성을 보장하려면 스레드 동기화로 한 번에 하나의 스레드만 공유 자원에 접근할 수 있게 해야 한다.  
Java에서는 Monitor를 이용해 스레드를 동기화한다. 모든 Java 객체는 하나의 Monitor를 가지고 있다. 그리고 Monitor는 하나의 스레드만 소유할 수 있다.  
어떠한 스레드가 소유한 Monitor를 다른 스레드가 획득하려면 해당 Monitor를 소유하고 있는 스레드가 Monitor를 해제할 때까지 Wait Queue에서 대기하고 있어야 한다.  


		
- 스레드 경합상태(race condition)
기본적으로 경합상태란 둘 이상의 입력 또는 조작의 타이밍이나 순서 등이 결과값에 영향을 줄 수 있는 상태를 말한다.   
입력 변화의 타이밍이나 순서가 예상과 다르게 작동하면 정상적인 결과가 나오지 않게 될 위험이 있는데 이를 경쟁 위험이라고 한다.  
쉽게 설명하자면, **두 개의 스레드가 너도 나도 같은 값을 변경하려고 요청 할 때 경합상태가 발생** 한다는 것이다.  
이때 스레드는 다른 스레드가 획득하고 있는 락(lock)이 해제되기를 기다리게 된다.   
웹 애플리케이션에서 여러 스레드가 공유 자원에 접근하는 일은 매우 빈번하다.   
대표적으로 로그를 기록하는 것도 로그를 기록하려는 스레드가 락을 획득하고 공유 자원에 접근하는 것이다.  


- 교착상태(deadlock)  
 스레드 경합상태에서 deadlock이 발생하는 경우가 종종있다.
 아주 쉽게 설명하자면, 아래 그림과 같다. 이러지도 저러지도 못하는 상태.

 두 개 이상의 작업이 서로 상대방의 작업이 끝나기 만을 기다리고 있기 때문에 결과적으로 아무것도 완료되지 못하는 상태를 가리킨다.  
 예를 들어 하나의 사다리가 있고, 두 명의 사람이 각각 사다리의 위쪽과 아래쪽에 있다고 가정한다.  
 이때 아래에 있는 사람은 위로 올라 가려고 하고, 위에 있는 사람은 아래로 내려오려고 한다면, 두 사람은 서로 상대방이 사다리에서 비켜줄 때까지 하염없이 기다리고 있을 것이고 결과적으로 아무도 사다리를 내려오거나 올라가지 못하게 되듯이, 전산학에서 교착 상태란 다중 프로그래밍 환경에서 흔히 발생할 수 있는 문제이다.  
 이 문제를 해결하는 일반적인 방법은 아직 없는 상태이다.


- 임계 영역(critical section) 
임계 영역 또는 공유변수 영역은 병렬컴퓨팅에서 둘 이상의 스레드가 동시에 접근해서는 안되는 공유 자원(자료 구조 또는 장치)을 접근하는 코드의 일부를 말한다.  
임계 구역은 지정된 시간이 지난 후 종료된다. 때문에 어떤 스레드(태스크 또는 프로세스)가 임계 구역에 들어가고자 한다면 지정된 시간만큼 대기해야 한다.   
스레드가 공유자원의 배타적인 사용을 보장받기 위해서 임계 구역에 들어가거나 나올때는 세마포어 같은 동기화 매커니즘이 사용된다.  
```java
코드 예시
do {
      wait(mutex);   //입장 구역
      임계 구역 //이곳이 임계 구역이다!! 하나의 스레드만 접근해야 한다.
      signal(mutex); //퇴장 구역
      나머지 구역
}
```




```
참고
https://www.tutorialspoint.com/user-level-threads-and-kernel-level-threads  
https://www.crocus.co.kr/1255 [Crocus]
https://d2.naver.com/helloworld/10963
```
